<% if admin_unit.shapefile_file_name %>
  <div class="row-fluid">
      <h4 class="text-info">
        <a id="auIdentifier" rel="popover" data-original-title="Help"><%= admin_unit.identifier %></a>
        <span class="text-success pull-right">&nbsp;<%= number_to_human_size(admin_unit.shapefile_file_size) %></span>
        <a id="auInfo" class="text-warning pull-right" rel="popover" data-original-title=""> [<%= admin_unit.shapefile_file_name %>] - </a>
      </h4>
  </div>
  <!-- Action steps -->
  <div id="adminUnitsSteps" class="row-fluid psteps_strict" title="<%= admin_unit.condition %>">
      <div class="span3">
        <div class="step-title"><span class="step-order">1.</span> <span class="step-name">Unzip Content</span></div>
        <div class="step-title"><span class="step-order">2.</span> <span class="step-name">Process</span></div>
        <div class="step-title"><span class="step-order">3.</span> <span class="step-name">Archive</span></div>
        <div class="step-title"><span class="step-order">4.</span> <span class="step-name">Information</span></div>
      </div>
      <div class="span9 well clearfix">
          <div class="step-content">
            <blockquote>
              <p class="text-info">File Name: <%= admin_unit.shapefile_file_name %></p>
              <p class="text-error">File Size: <%= number_to_human_size(admin_unit.shapefile_file_size) %></p>
              <p class="text-warning">Condition: <%= admin_unit.condition %></p>
              <%= link_to("Extract", extract_version_path(:id => admin_unit.id), :class => "btn btn-info action", :remote => true) %>
            </blockquote>
          </div>

          <!-- PROCESSING -->
          <div class="step-content">
            <div class="row-fluid">
              <div class="span4"><button id="auSaveSelectionBtn" class="btn btn-success" href="#saveAuMappingsModal" data-toggle="modal">Save Mappings</button></div>
              <div class="span4"><button id="auClearSelectionBtn" class="btn btn-inverse">Clear Mappings</button></div>
              <div class="span4"><button id="auTransformBtn" class="btn btn-primary action">Transform Data</button></div>
            </div>
            <br>
            <div class="accordion" id="saved_mappings">
              <% mappings_of('au').each do |mapping| %>
                <div class="accordion-group">
                  <div class="accordion-heading">
                    <a class="accordion-toggle" data-toggle="collapse" href="#<%= mapping.id %>">
                      <%= mapping.name %>
                    </a>
                  </div>
                  <div id="<%= mapping.id %>" class="accordion-body collapse in">
                    <div class="accordion-inner">
                      <%= mapping.data %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>


            <input id="auSchema" value="<%= schema('AU') %>" class="hide"/>
            <input id="auShapeSchema" value="<%= admin_unit.note %>" class="hide">
            <div class="span4">
              <table id="auSchemaTable" class="table table-striped table-condensed table-bordered">
                <thead>
                  <tr><th>Column</th></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="span5">
              <table id="auTable" class="table table-striped table-condensed table-bordered">
                <thead>
                  <tr><th>Attribute</th><th>Mapped</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <!-- ARCHIVE -->
          <div class="step-content">
            <!-- Information DIV -->
            <div id="checkResultDiv" class="hidden">
              <button type="button" class="close" data-dismiss="alert">&times;</button>
              <strong><span id="deactivateErrors"></span></strong>
            </div>
            <!-- /END Information DIV -->

            <!-- Deactivation FORM -->
            <%= form_tag(deactivate_version_path, :remote => true, :method => :put, "onsubmit" => "return $(this).validate()") do %>
              <div class="input-prepend input-append">
                <span class="add-on">Archive Location</span>
                <%= text_field_tag 'location', nil, {:class => "input-xlarge aulocation"} %>
                <%= hidden_field_tag 'schema', 'au' %>
                <%= hidden_field_tag 'shapeid', admin_unit.id %>
                <%= link_to("Check", folder_exists_version_path(:location => ""), :id => "checkFolderLink",:class => "btn btn-info", :remote => true) %>
              </div>
              <div class="input-append">
                <label class="checkbox">
                  <%= check_box_tag 'compress', true, false %>
                  Compress data
                </label>
                <label class="checkbox">
                  <%= check_box_tag 'default_path', true, false, :class => 'au_default_path' %>
                  Default Folder
                </label>
                <%= submit_tag "Deactivate", :id => "deactivateVersionBtn" ,:class => "btn btn-info" %>
              </div>

            <% end %>
            <!-- /END Deactivation FORM -->
          </div>
          <div class="step-content">
            <table class="table table-condensed table-striped">
              <tr>
                <td>Features</td>
                <td><%= admin_unit.features %></td>
              </tr>
              <tr>
                <td>Archive</td>
                <td><%= link_to 'Download', download_archive_version_path(:path => admin_unit.archive_path) %></td>
              </tr>
              <tr>
                <td>User</td>
                <td><%= admin_unit.version.user.email %></td>
              </tr>
            </table>
          </div>

          <div style="clear:both;"></div>
      </div>
  </div>
  <% unless admin_unit.faults.nil? %>
    <div class="alert">
      <button type="button" class="close" data-dismiss="alert">&times;</button>
      <strong>Error: </strong> <%= admin_unit.faults %>
      <%= link_to 'Delete Version', @version, :confirm => "Delete #{@version.name}?", :method => :delete %>
    </div>
  <% end %>

<%= form_tag transform_version_path, {:id => 'au_transform_data_form', :remote => true} do %>
  <%= hidden_field_tag :map_list, "" %>
  <%= hidden_field_tag :shapeid, admin_unit.id %>
  <%= hidden_field_tag :type, "au" %>
<% end %>

  <script type="text/javascript">
    $(function(){
      var helper = $("#auIdentifier").data("popover");
      helper.options.placement = "left";
      helper.options.html = true;
      helper.options.content = $('#au_sample_mapper').html();

      loadInfo($("#auShapeSchema").val(), "auInfo");

      modelSchema($("#auSchema").val(), "auTable");
      shapeSchema($("#auShapeSchema").val(), "auSchemaTable");


      setDraggable("auShapeSchema", "adminUnitsSteps");
      setDroppable("auTable");

      $("#auTransformBtn").click(function(){
        $("#au_transform_data_form #map_list").val(schemaTableJSON("auTable"));
        $("#au_transform_data_form").submit();
        return false;
      });

      $("#au_transform_data_form").submit(function(){
        $("#au_transform_data_form #map_list").val(schemaTableJSON("auTable"));
      });

      $("#auClearSelectionBtn").click(function(){
        clearSchemaTable("auTable");
        setDroppable("auTable");
      });

      $(".au_default_path").change(function(){
        if( this.checked ){
          $(".aulocation").attr("disabled", "disabled");
        }else{
          $(".aulocation").removeAttr("disabled");
        }
      });

      $(".accordion-toggle").click(function(){
        var dataId = $(this).attr("href");
        var data = $(dataId+" > div").html();
        load_mapping_table(data, "auTable");
      });
    });
  </script>

<!-- End Action steps -->
<% else %>
  <div class="row-fluid">
    <h4 class="text-info">Administrative Units</h4>
  </div>
  <div class="hero-unit">
    <h1 class="text-center text-warning">Administrative Units <span class="text-info">Missing</span></h1>
  </div>
<% end %>

<div id="au_sample_mapper" style="display: none">
    <table id="sampleMappingAu" class="table table-striped table-condensed table-bordered">
      <thead>
        <tr><th>Attribute</th><th>Mapped</th>
        </tr>
      </thead>
      <tbody>
        <tr><td class="key">identifier</td><td>shn</td></tr>
        <tr><td class="key">name</td><td>namn</td></tr>
        <tr><td class="key">code</td><td>icc</td></tr>
        <tr><td class="key">natcode</td><td>shn</td></tr>
        <tr><td class="key">levelname</td><td>desn</td></tr>
        <tr><td class="key">level</td><td>natlevel</td></tr>
    </table>
</div>

